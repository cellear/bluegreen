<?php
/**
 * @file
 * Blue-Green Deployment module.
 *
 * Provides dual database environment management for safe deployment and
 * easy rollback functionality.
 */

/**
 * Implements hook_menu().
 */
function bluegreen_menu() {
  $items = array();

  $items['admin/content/bluegreen'] = array(
    'title' => 'Blue-Green Deployment',
    'description' => 'Manage Blue and Green database environments for deployment.',
    'page callback' => 'backdrop_get_form',
    'page arguments' => array('bluegreen_admin_form'),
    'access arguments' => array('administer bluegreen deployment'),
    'file' => 'bluegreen.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/content/bluegreen/overview'] = array(
    'title' => 'Overview',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );

  $items['admin/content/bluegreen/setup'] = array(
    'title' => 'Setup',
    'description' => 'Set up Blue-Green deployment for this site.',
    'page callback' => 'backdrop_get_form',
    'page arguments' => array('bluegreen_setup_form'),
    'access arguments' => array('administer bluegreen deployment'),
    'file' => 'bluegreen.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 10,
  );

  $items['admin/content/bluegreen/switch/%'] = array(
    'title' => 'Switch Environment',
    'page callback' => 'bluegreen_switch_environment_callback',
    'page arguments' => array(4),
    'access arguments' => array('switch environments'),
    'file' => 'bluegreen.admin.inc',
    'type' => MENU_CALLBACK,
  );

  $items['admin/content/bluegreen/sync/%/%'] = array(
    'title' => 'Sync Environment',
    'page callback' => 'bluegreen_sync_environment_callback',
    'page arguments' => array(4, 5),
    'access arguments' => array('sync environments'),
    'file' => 'bluegreen.admin.inc',
    'type' => MENU_CALLBACK,
  );

  $items['admin/content/bluegreen/backup/%'] = array(
    'title' => 'Backup Environment',
    'page callback' => 'bluegreen_backup_environment_callback',
    'page arguments' => array(4),
    'access arguments' => array('sync environments'),
    'file' => 'bluegreen.admin.inc',
    'type' => MENU_CALLBACK,
  );

  $items['admin/content/bluegreen/clear-cache'] = array(
    'title' => 'Clear Cache After Switch',
    'page callback' => 'bluegreen_clear_cache_callback',
    'access arguments' => array('switch environments'),
    'file' => 'bluegreen.admin.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function bluegreen_permission() {
  return array(
    'administer bluegreen deployment' => array(
      'title' => t('Administer blue-green deployment'),
      'description' => t('Full access to blue-green deployment management, including switching and syncing environments.'),
      'restrict access' => TRUE,
    ),
    'switch environments' => array(
      'title' => t('Switch environments'),
      'description' => t('Switch which environment (Blue or Green) is live.'),
      'restrict access' => TRUE,
    ),
    'sync environments' => array(
      'title' => t('Sync environments'),
      'description' => t('Sync database content between Blue and Green environments.'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Get the currently active environment.
 *
 * @return string
 *   Either 'blue' or 'green'.
 */
function bluegreen_get_active_environment() {
  // Use state system instead of global variable
  return state_get('bluegreen_active_environment', 'blue');
}

/**
 * Get database connection information for an environment.
 *
 * @param string $environment
 *   Either 'blue' or 'green'.
 *
 * @return array|false
 *   Database connection array or FALSE if not configured.
 */
function bluegreen_get_environment_info($environment) {
  global $databases;
  
  if (isset($databases[$environment]['default'])) {
    return $databases[$environment]['default'];
  }
  
  return FALSE;
}

/**
 * Check if blue-green deployment is properly configured.
 *
 * @return bool
 *   TRUE if both blue and green databases are configured.
 */
function bluegreen_is_configured() {
  $blue_configured = bluegreen_get_environment_info('blue') !== FALSE;
  $green_configured = bluegreen_get_environment_info('green') !== FALSE;

  if (!$blue_configured || !$green_configured) {
    return FALSE;
  }

  // Both environments must actually have table sets before we consider the
  // module configured. This avoids flagging success when setup never cloned.
  return (bluegreen_environment_is_installed('blue') &&
          bluegreen_environment_is_installed('green'));
}

/**
 * Get the idle (non-active) environment name.
 *
 * @return string
 *   Either 'blue' or 'green'.
 */
function bluegreen_get_idle_environment() {
  $active = bluegreen_get_active_environment();
  return $active === 'blue' ? 'green' : 'blue';
}

/**
 * Get list of tables that should be shared across both environments.
 *
 * These tables are NOT duplicated and NOT synced between environments.
 * They maintain a single copy used by both blue and green.
 *
 * @return array
 *   Array of table base names (without prefix) that should be shared.
 */
function bluegreen_get_shared_tables() {
  return array(
    'state',           // System state - needs to persist across switches
    'watchdog',        // Log entries - single audit trail
    'users',           // User accounts - prevent password rollbacks
    'users_roles',     // User role assignments
    'role',            // Roles definition
    'role_permission', // Role permissions
    'authmap',         // External authentication mappings
    'sessions',        // Active sessions - keep users logged in
  );
}

/**
 * Get last sync timestamp for an environment.
 *
 * @param string $environment
 *   Either 'blue' or 'green'.
 *
 * @return int|false
 *   Unix timestamp or FALSE if never synced.
 */
function bluegreen_get_last_sync($environment) {
  return state_get('bluegreen_last_sync_' . $environment, FALSE);
}

/**
 * Set last sync timestamp for an environment.
 *
 * @param string $environment
 *   Either 'blue' or 'green'.
 * @param int $timestamp
 *   Unix timestamp.
 */
function bluegreen_set_last_sync($environment, $timestamp = NULL) {
  if ($timestamp === NULL) {
    $timestamp = REQUEST_TIME;
  }
  state_set('bluegreen_last_sync_' . $environment, $timestamp);
}

/**
 * Get table count for an environment.
 *
 * @param string $environment
 *   Either 'blue' or 'green'.
 *
 * @return int
 *   Number of tables in the environment.
 */
function bluegreen_get_table_count($environment) {
  $info = bluegreen_get_environment_info($environment);
  if (!$info) {
    return 0;
  }

  try {
    // Ensure all required fields are set with defaults
    $info += array(
      'driver' => 'mysql',
      'host' => 'localhost',
      'port' => 3306,
      'username' => '',
      'password' => '',
      'prefix' => '',
    );
    
    // Connect to the specific environment
    Database::addConnectionInfo($environment . '_temp', 'default', $info);
    Database::setActiveConnection($environment . '_temp');
    $connection = Database::getConnection('default', $environment . '_temp');
    
    // Get tables with the environment's prefix
    // Handle both string and array-based prefixes
    if (is_array($info['prefix'])) {
      $prefix = isset($info['prefix']['default']) ? $info['prefix']['default'] : '';
    }
    else {
      $prefix = !empty($info['prefix']) ? $info['prefix'] : '';
    }
    $tables = $connection->schema()->findTables($prefix . '%');
    
    // Restore default connection
    Database::setActiveConnection('default');
    Database::removeConnection($environment . '_temp');
    
    return count($tables);
  }
  catch (Exception $e) {
    watchdog('bluegreen', 'Error counting tables for @env: @message', 
      array('@env' => $environment, '@message' => $e->getMessage()), 
      WATCHDOG_ERROR);
    
    // Make sure to restore connection even on error
    try {
      Database::setActiveConnection('default');
      Database::removeConnection($environment . '_temp');
    }
    catch (Exception $e2) {
      // Ignore cleanup errors
    }
    
    return 0;
  }
}

/**
 * Check if an environment has been installed (has tables).
 *
 * @param string $environment
 *   Either 'blue' or 'green'.
 *
 * @return bool
 *   TRUE if environment has tables.
 */
function bluegreen_environment_is_installed($environment) {
  return bluegreen_get_table_count($environment) > 0;
}

/**
 * Detect the current active config directory.
 *
 * Backdrop stores config in files/config_[hash]/active by default.
 * This function finds that directory.
 *
 * @return string|false
 *   Path to active config directory, or FALSE if not found.
 */
function bluegreen_detect_config_directory() {
  // Check for Backdrop's config API function
  if (function_exists('config_get_config_directory')) {
    return config_get_config_directory('active');
  }

  // Fallback: scan files directory for config_* folders
  $files_path = 'files';
  if (is_dir($files_path)) {
    $dirs = scandir($files_path);
    foreach ($dirs as $dir) {
      if (strpos($dir, 'config_') === 0 && is_dir($files_path . '/' . $dir . '/active')) {
        return $files_path . '/' . $dir . '/active';
      }
    }
  }

  return FALSE;
}

/**
 * Get config directory path for an environment.
 *
 * @param string $environment
 *   Either 'blue' or 'green'.
 * @param string $type
 *   Either 'active' or 'staging'. Defaults to 'active'.
 *
 * @return string|false
 *   Path to config directory, or FALSE if not found.
 */
function bluegreen_get_config_directory($environment, $type = 'active') {
  $base_config = bluegreen_detect_config_directory();

  if (!$base_config) {
    return FALSE;
  }

  // Extract base directory (without /active)
  $base_path = dirname($base_config);

  // For green environment, use _alt suffix
  if ($environment === 'green') {
    $base_path .= '_alt';
  }

  return $base_path . '/' . $type;
}

/**
 * Count config files in an environment.
 *
 * @param string $environment
 *   Either 'blue' or 'green'.
 * @param string $type
 *   Either 'active' or 'staging'. Defaults to 'active'.
 *
 * @return int
 *   Number of JSON config files found.
 */
function bluegreen_count_config_files($environment, $type = 'active') {
  $config_dir = bluegreen_get_config_directory($environment, $type);

  if (!$config_dir || !is_dir($config_dir)) {
    return 0;
  }

  $files = glob($config_dir . '/*.json');
  return is_array($files) ? count($files) : 0;
}

/**
 * Recursively copy a directory.
 *
 * @param string $source
 *   Source directory path.
 * @param string $destination
 *   Destination directory path.
 *
 * @return int
 *   Number of files copied.
 *
 * @throws Exception
 */
function bluegreen_copy_directory($source, $destination) {
  if (!is_dir($source)) {
    throw new Exception(t('Source directory does not exist: @dir',
      array('@dir' => $source)));
  }

  // Create destination if it doesn't exist
  if (!is_dir($destination)) {
    if (!mkdir($destination, 0755, TRUE)) {
      throw new Exception(t('Failed to create directory: @dir',
        array('@dir' => $destination)));
    }
  }

  $count = 0;
  $files = scandir($source);

  foreach ($files as $file) {
    if ($file === '.' || $file === '..') {
      continue;
    }

    $source_file = $source . '/' . $file;
    $dest_file = $destination . '/' . $file;

    if (is_dir($source_file)) {
      // Recursive copy for subdirectories
      $count += bluegreen_copy_directory($source_file, $dest_file);
    } else {
      // Copy file
      if (copy($source_file, $dest_file)) {
        chmod($dest_file, 0644);
        $count++;
      }
    }
  }

  return $count;
}

/**
 * Sync config files from one environment to another.
 *
 * @param string $from
 *   Source environment ('blue' or 'green').
 * @param string $to
 *   Target environment ('blue' or 'green').
 *
 * @return array
 *   Array with 'active' and 'staging' counts.
 *
 * @throws Exception
 */
function bluegreen_sync_config_files($from, $to) {
  // Sync active config
  $from_active = bluegreen_get_config_directory($from, 'active');
  $to_active = bluegreen_get_config_directory($to, 'active');

  if (!$from_active) {
    throw new Exception(t('Could not find config directory for @env',
      array('@env' => $from)));
  }

  $active_count = bluegreen_copy_directory($from_active, $to_active);

  // Sync staging config
  $from_staging = bluegreen_get_config_directory($from, 'staging');
  $to_staging = bluegreen_get_config_directory($to, 'staging');

  $staging_count = 0;
  if ($from_staging && is_dir($from_staging)) {
    $staging_count = bluegreen_copy_directory($from_staging, $to_staging);
  }

  watchdog('bluegreen',
    'Synced @total config files from @from to @to (@active active, @staging staging)',
    array(
      '@total' => $active_count + $staging_count,
      '@from' => $from,
      '@to' => $to,
      '@active' => $active_count,
      '@staging' => $staging_count,
    ),
    WATCHDOG_INFO
  );

  return array(
    'active' => $active_count,
    'staging' => $staging_count,
    'total' => $active_count + $staging_count,
  );
}

/**
 * Create alternate config directory for green environment.
 *
 * Called during initial setup to create the _alt config directory.
 *
 * @return bool
 *   TRUE if created successfully, FALSE otherwise.
 *
 * @throws Exception
 */
function bluegreen_create_alt_config_directory() {
  $base_config = bluegreen_detect_config_directory();

  if (!$base_config) {
    throw new Exception(t('Could not detect current config directory.'));
  }

  // Get base path (without /active)
  $base_path = dirname($base_config);
  $alt_path = $base_path . '_alt';

  // Check if already exists
  if (is_dir($alt_path)) {
    watchdog('bluegreen',
      'Alternate config directory already exists: @path',
      array('@path' => $alt_path),
      WATCHDOG_WARNING
    );
    return TRUE;
  }

  // Create active and staging directories
  $alt_active = $alt_path . '/active';
  $alt_staging = $alt_path . '/staging';

  if (!mkdir($alt_active, 0755, TRUE)) {
    throw new Exception(t('Failed to create directory: @dir',
      array('@dir' => $alt_active)));
  }

  if (!mkdir($alt_staging, 0755, TRUE)) {
    throw new Exception(t('Failed to create directory: @dir',
      array('@dir' => $alt_staging)));
  }

  // Copy all files from blue to green
  $active_count = bluegreen_copy_directory($base_config, $alt_active);

  $staging_source = $base_path . '/staging';
  $staging_count = 0;
  if (is_dir($staging_source)) {
    $staging_count = bluegreen_copy_directory($staging_source, $alt_staging);
  }

  watchdog('bluegreen',
    'Created alternate config directory with @total files (@active active, @staging staging)',
    array(
      '@total' => $active_count + $staging_count,
      '@active' => $active_count,
      '@staging' => $staging_count,
    ),
    WATCHDOG_INFO
  );

  return TRUE;
}

/**
 * Implements hook_init().
 */
function bluegreen_init() {
  // Add admin CSS if on the blue-green admin page
  if (arg(0) == 'admin' && arg(1) == 'content' && arg(2) == 'bluegreen') {
    backdrop_add_css(backdrop_get_path('module', 'bluegreen') . '/css/bluegreen.admin.css');
  }
}

/**
 * Implements hook_admin_bar_output_build().
 */
function bluegreen_admin_bar_output_build(&$content) {
  if (!bluegreen_is_configured()) {
    return;
  }
  
  $active = bluegreen_get_active_environment();
  $color_name = ucfirst($active);
  
  // Add environment indicator to admin bar
  $content['environment'] = array(
    '#theme' => 'admin_bar_links',
    '#wrapper_attributes' => array(
      'id' => 'admin-bar-environment',
      'class' => array('admin-bar-environment', 'environment-' . $active),
    ),
    '#weight' => -100,
  );
  
  $content['environment']['indicator'] = array(
    '#title' => '<span class="environment-label">' . $color_name . '</span>',
    '#href' => 'admin/content/bluegreen',
    '#options' => array(
      'html' => TRUE,
      'attributes' => array(
        'class' => array('environment-link'),
        'title' => t('Current environment: @env', array('@env' => $color_name)),
      ),
    ),
    '#weight' => 0,
  );
  
  // Add CSS for styling
  backdrop_add_css(backdrop_get_path('module', 'bluegreen') . '/css/bluegreen.admin.css');
}
